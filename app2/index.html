<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C√¥ng c·ª• D·ª± to√°n T√†i ch√≠nh - Payback Period & Scenarios</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .money-preview { @apply text-[10px] text-blue-500 mt-1 font-medium; }
        .table-scenario th, .table-scenario td { @apply p-3 border-b border-gray-100; }
    </style>
</head>
<body class="bg-gray-50 font-sans">

    <div class="container mx-auto p-4 max-w-6xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold text-blue-900 uppercase">D·ª± to√°n Ho√†n v·ªën ƒë·∫ßu t∆∞</h1>
            <p class="text-gray-500 italic">C√¥ng c·ª• ph√¢n t√≠ch r·ªßi ro & ƒëi·ªÉm h√≤a v·ªën chuy√™n nghi·ªáp</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg border-t-4 border-blue-600 h-fit">
                <h2 class="text-lg font-bold mb-4 text-gray-700">Th√¥ng s·ªë kinh doanh</h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase">V·ªën ƒë·∫ßu t∆∞ ban ƒë·∫ßu</label>
                        <input type="number" id="initialInvestment" oninput="updatePreview(this)" class="w-full mt-1 p-2 bg-gray-50 border rounded-md" value="100000000">
                        <p id="initialInvestment-preview" class="money-preview">100.000.000ƒë</p>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase">Chi ph√≠ c·ªë ƒë·ªãnh (FC)/th√°ng</label>
                        <input type="number" id="fixedCosts" oninput="updatePreview(this)" class="w-full mt-1 p-2 bg-gray-50 border rounded-md" value="10000000">
                        <p id="fixedCosts-preview" class="money-preview">10.000.000ƒë</p>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase">Gi√° b√°n m·ªói ƒë∆°n v·ªã (P)</label>
                        <input type="number" id="pricePerUnit" oninput="updatePreview(this)" class="w-full mt-1 p-2 bg-gray-50 border rounded-md" value="200000">
                        <p id="pricePerUnit-preview" class="money-preview">200.000ƒë</p>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase">Bi·∫øn ph√≠ (VC)/ƒë∆°n v·ªã</label>
                        <input type="number" id="variableCostPerUnit" oninput="updatePreview(this)" class="w-full mt-1 p-2 bg-gray-50 border rounded-md" value="50000">
                        <p id="variableCostPerUnit-preview" class="money-preview">50.000ƒë</p>
                    </div>
                    <div class="p-3 bg-yellow-50 rounded-lg border border-yellow-200">
                        <label class="block text-xs font-bold text-yellow-700 uppercase">S·∫£n l∆∞·ª£ng b√°n d·ª± ki·∫øn/th√°ng</label>
                        <input type="number" id="expectedSales" class="w-full mt-1 p-2 border-yellow-300 border rounded-md focus:ring-yellow-500" value="150">
                        <p class="text-[10px] text-yellow-600 mt-1">* C∆° s·ªü ƒë·ªÉ ph√¢n t√≠ch k·ªãch b·∫£n</p>
                    </div>
                    <button id="btnSubmit" onclick="processData()" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 shadow-md transition-all">
                        PH√ÇN T√çCH NGAY
                    </button>
                </div>
            </div>

            <div class="lg:col-span-3 space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-white p-4 rounded-xl shadow border-b-4 border-blue-400 text-center">
                        <p class="text-xs font-bold text-gray-400 uppercase">H√≤a v·ªën t·∫°i s·∫£n l∆∞·ª£ng</p>
                        <h3 class="text-xl font-black text-blue-600" id="resUnits">0</h3>
                        <p class="text-[10px] text-gray-400">s·∫£n ph·∫©m/th√°ng</p>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow border-b-4 border-green-400 text-center">
                        <p class="text-xs font-bold text-gray-400 uppercase">L·ª£i nhu·∫≠n m·ª•c ti√™u/th√°ng</p>
                        <h3 class="text-xl font-black text-green-600" id="resProfit">0ƒë</h3>
                        <p class="text-[10px] text-gray-400">sau khi tr·ª´ t·∫•t c·∫£ chi ph√≠</p>
                    </div>
                    <div class="bg-blue-600 p-4 rounded-xl shadow text-white text-center">
                        <p class="text-xs font-bold uppercase opacity-80">Th·ªùi gian ho√†n v·ªën (Base Case)</p>
                        <h3 class="text-2xl font-black" id="resPayback">...</h3>
                        <p class="text-[10px] opacity-80" id="paybackStatus">ƒêang t√≠nh to√°n...</p>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-xl shadow border border-gray-100">
                    <h2 class="text-lg font-bold mb-4 text-gray-700">Bi·ªÉu ƒë·ªì ƒêi·ªÉm h√≤a v·ªën & Doanh thu</h2>
                    <canvas id="bepChart" width="400" height="150"></canvas>
                </div>

                <div class="bg-white p-6 rounded-xl shadow border border-gray-100">
                    <h2 class="text-lg font-bold mb-4 text-gray-700 flex items-center">
                        <span class="mr-2">üìä</span> Ph√¢n t√≠ch k·ªãch b·∫£n r·ªßi ro (Bi·∫øn ƒë·ªông doanh s·ªë)
                    </h2>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left table-scenario">
                            <thead>
                                <tr class="bg-gray-50 text-gray-600 uppercase text-[10px] font-bold tracking-wider">
                                    <th>K·ªãch b·∫£n</th>
                                    <th class="text-center">S·∫£n l∆∞·ª£ng</th>
                                    <th class="text-right">L·ª£i nhu·∫≠n/th√°ng</th>
                                    <th class="text-right">Th·ªùi gian ho√†n v·ªën</th>
                                </tr>
                            </thead>
                            <tbody id="scenarioTableBody">
                                </tbody>
                        </table>
                    </div>
                    <p class="text-[10px] text-gray-400 mt-4 italic">* K·ªãch b·∫£n T·ªá v√† T·ªët d·ª±a tr√™n m·ª©c bi·∫øn ƒë·ªông ¬±30% so v·ªõi d·ª± ki·∫øn ban ƒë·∫ßu.</p>
                </div>
            </div>
        </div>
    </div>

<script>
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyfjRxEvvryHR5ag0kAt8k7mBocl072L234U4H6vR7yZAspKuQlXhu0Ght-5F8PXp7unw/exec';
    let myChart;

    // 1. ƒê·ªãnh d·∫°ng ti·ªÅn t·ªá VND
    function formatVND(amount) {
        return new Intl.NumberFormat('vi-VN').format(Math.round(amount)) + "ƒë";
    }

    // 2. C·∫≠p nh·∫≠t preview khi g√µ s·ªë
    function updatePreview(input) {
        const previewId = input.id + "-preview";
        const previewElement = document.getElementById(previewId);
        if (previewElement) {
            previewElement.innerText = formatVND(parseFloat(input.value) || 0);
        }
    }

    // 3. Logic ph√¢n t√≠ch k·ªãch b·∫£n (Scenario Analysis)
    function renderScenarios(inputs, margin) {
        const scenarios = [
            { name: "K·ªãch b·∫£n T·ªá (-30%)", multiplier: 0.7, color: "text-red-600 font-bold bg-red-50" },
            { name: "C∆° s·ªü (K·∫ø ho·∫°ch)", multiplier: 1.0, color: "text-blue-600 font-bold bg-blue-50" },
            { name: "K·ªãch b·∫£n T·ªët (+30%)", multiplier: 1.3, color: "text-green-600 font-bold bg-green-50" }
        ];

        const tbody = document.getElementById('scenarioTableBody');
        tbody.innerHTML = ""; 

        scenarios.forEach(scen => {
            const currentSales = Math.round(inputs.expectedSales * scen.multiplier);
            const currentProfit = (margin * currentSales) - inputs.fixedCosts;
            
            let payback = "V√¥ h·∫°n (L·ªó)";
            if (currentProfit > 0) {
                payback = Math.ceil(inputs.initialInvestment / currentProfit) + " th√°ng";
            }

            const row = `
                <tr class="hover:bg-gray-50 transition-colors">
                    <td class="p-3 ${scen.color}">${scen.name}</td>
                    <td class="text-center font-semibold text-gray-600">${currentSales.toLocaleString()} SP</td>
                    <td class="text-right font-bold text-gray-700">${formatVND(currentProfit > 0 ? currentProfit : 0)}</td>
                    <td class="text-right font-black text-blue-900">${payback}</td>
                </tr>
            `;
            tbody.innerHTML += row;
        });
    }

    window.onload = function() {
        const savedData = localStorage.getItem('bepAppData');
        if (savedData) {
            const data = JSON.parse(savedData);
            Object.keys(data).forEach(key => {
                const el = document.getElementById(key);
                if (el) {
                    el.value = data[key];
                    updatePreview(el);
                }
            });
        }
        refreshUI(false); 
    };

    async function processData() { await refreshUI(true); }

    async function refreshUI(shouldSendToSheet) {
        const btn = document.getElementById('btnSubmit');
        const inputs = {
            initialInvestment: parseFloat(document.getElementById('initialInvestment').value) || 0,
            fixedCosts: parseFloat(document.getElementById('fixedCosts').value) || 0,
            pricePerUnit: parseFloat(document.getElementById('pricePerUnit').value) || 0,
            variableCostPerUnit: parseFloat(document.getElementById('variableCostPerUnit').value) || 0,
            expectedSales: parseFloat(document.getElementById('expectedSales').value) || 0
        };

        const margin = inputs.pricePerUnit - inputs.variableCostPerUnit;
        if (margin <= 0) { alert("L·ªói: Gi√° b√°n ph·∫£i l·ªõn h∆°n bi·∫øn ph√≠!"); return; }

        // T√≠nh to√°n ch√≠nh
        const bepUnits = Math.ceil(inputs.fixedCosts / margin);
        const bepRevenue = bepUnits * inputs.pricePerUnit;
        const monthlyProfit = (margin * inputs.expectedSales) - inputs.fixedCosts;
        
        let paybackMonths = 0;
        let paybackText = "";

        if (monthlyProfit <= 0) {
            paybackText = "V√¥ h·∫°n";
            document.getElementById('paybackStatus').innerText = "Kinh doanh ƒëang l·ªó";
        } else {
            paybackMonths = Math.ceil(inputs.initialInvestment / monthlyProfit);
            paybackText = paybackMonths + " th√°ng";
            document.getElementById('paybackStatus').innerText = `Thu h·ªìi ${formatVND(inputs.initialInvestment)}`;
        }

        // C·∫≠p nh·∫≠t UI Dashboard
        document.getElementById('resUnits').innerText = bepUnits.toLocaleString('vi-VN');
        document.getElementById('resProfit').innerText = formatVND(monthlyProfit > 0 ? monthlyProfit : 0);
        document.getElementById('resPayback').innerText = paybackText;

        // C·∫≠p nh·∫≠t c√°c k·ªãch b·∫£n v√† bi·ªÉu ƒë·ªì
        renderScenarios(inputs, margin);
        updateChart(inputs, bepUnits);
        localStorage.setItem('bepAppData', JSON.stringify(inputs));

        // G·ª≠i d·ªØ li·ªáu l√™n Sheets
        if (shouldSendToSheet) {
            btn.innerText = "ƒêANG L∆ØU...";
            btn.disabled = true;
            try {
                await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST', mode: 'no-cors', cache: 'no-cache',
                    body: JSON.stringify({...inputs, bepUnits, bepRevenue, paybackMonths})
                });
                alert("D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c ƒë·ªìng b·ªô l√™n Google Sheets!");
            } catch (e) {
                alert("L·ªói k·∫øt n·ªëi ƒë·ªìng b·ªô!");
            } finally {
                btn.innerText = "PH√ÇN T√çCH NGAY";
                btn.disabled = false;
            }
        }
    }

    function updateChart(inputs, bepUnits) {
        const ctx = document.getElementById('bepChart').getContext('2d');
        const labels = []; const revData = []; const costData = [];
        const range = Math.max(bepUnits * 2, inputs.expectedSales * 1.5);

        for (let i = 0; i <= range; i += Math.ceil(range/10)) {
            labels.push(i);
            revData.push(i * inputs.pricePerUnit);
            costData.push(inputs.fixedCosts + (i * inputs.variableCostPerUnit));
        }

        if (myChart) myChart.destroy();
        myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    { label: 'Doanh thu', data: revData, borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.1)', fill: true, tension: 0.3 },
                    { label: 'Chi ph√≠', data: costData, borderColor: '#ef4444', borderDash: [5, 5], fill: false, tension: 0.3 }
                ]
            },
            options: { 
                responsive: true,
                plugins: { legend: { position: 'bottom' } },
                scales: {
                    y: { ticks: { callback: v => v.toLocaleString('vi-VN') + 'ƒë' } },
                    x: { title: { display: true, text: 'S·∫£n l∆∞·ª£ng (ƒë∆°n v·ªã)' } }
                }
            }
        });
    }
</script>
</body>
</html>
